<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lawl Online - The 500+ Line Monolith</title>
    <style>
        :root {
            --gold: #ffcc00; --hp: #ff4757; --mp: #2f3542; --exp: #2ed573;
            --panel: rgba(12, 12, 18, 0.95); --border: #333;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: #000; color: #fff; font-family: 'Tahoma', sans-serif; overflow: hidden; user-select: none; }
        
        #game-container { position: relative; width: 854px; height: 480px; margin: auto; top: 50vh; transform: translateY(-50%); border: 5px solid #111; overflow: hidden; background: #000; }
        
        canvas { position: absolute; top: 0; left: 0; image-rendering: pixelated; }

        /* UI SYSTEM */
        .gui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 100; }
        .window { 
            position: absolute; background: var(--panel); border: 2px solid var(--gold);
            padding: 10px; display: none; pointer-events: all; box-shadow: 0 0 25px #000;
            border-radius: 4px;
        }

        /* SUPERIOR HUD */
        #main-hud { top: 15px; left: 15px; width: 280px; padding: 12px; background: rgba(0,0,0,0.85); border-left: 4px solid var(--gold); }
        .bar-container { height: 16px; background: #111; border: 1px solid #333; margin-top: 6px; position: relative; border-radius: 3px; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.4s ease-out; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 10px; top: 0; line-height: 16px; font-weight: bold; text-shadow: 1px 1px #000; }

        /* MULTI-TAB WINDOW (Inventory/Stats/Social) */
        #side-window { right: 15px; top: 15px; width: 240px; height: 400px; }
        .tabs { display: flex; gap: 2px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 5px; background: #222; border: 1px solid var(--border); color: #888; cursor: pointer; font-size: 10px; text-align: center; }
        .tab-btn.active { background: var(--gold); color: #000; font-weight: bold; }
        
        .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; height: 180px; overflow-y: auto; }
        .slot { width: 48px; height: 48px; background: #1a1a1a; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 24px; position: relative; }
        .slot:hover { border-color: var(--gold); background: #222; }

        /* ACTION BAR */
        #action-bar { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; }
        .skill { width: 44px; height: 44px; background: var(--panel); border: 2px solid #555; display: flex; align-items: center; justify-content: center; font-size: 22px; position: relative; cursor: pointer; }
        .skill.active { border-color: var(--gold); }
        .cooldown { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); height: 0%; }
        .hotkey { position: absolute; top: -2px; left: -2px; font-size: 9px; background: var(--gold); color: #000; padding: 1px 4px; font-weight: bold; }

        /* CHAT SYSTEM */
        #chat-wrapper { position: absolute; bottom: 75px; left: 15px; width: 320px; }
        #chat-log { height: 120px; background: rgba(0,0,0,0.7); overflow-y: scroll; padding: 8px; font-size: 12px; border: 1px solid #222; color: #ccc; scrollbar-width: none; }
        #chat-input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 8px; outline: none; }

        /* WORLD OVERLAYS */
        #notification { position: absolute; top: 30%; width: 100%; text-align: center; font-size: 28px; font-weight: bold; color: var(--gold); text-shadow: 0 0 10px #000; pointer-events: none; opacity: 0; }
        
        /* SCROLLBAR HIDE */
        #chat-log::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="c-map"></canvas>
    <canvas id="c-entities"></canvas>
    <canvas id="c-fx"></canvas>
    <canvas id="c-lighting" style="mix-blend-mode: multiply; pointer-events: none;"></canvas>

    <div class="gui-layer">
        <div id="main-hud">
            <div style="display:flex; justify-content: space-between;">
                <span id="p-name" style="color:var(--gold); font-weight:bold;">S8N_WARRIOR</span>
                <span id="p-lvl" style="color:#aaa;">Lv. 42</span>
            </div>
            <div class="bar-container"><div id="hp-f" class="bar-fill" style="background:var(--hp);"></div><div class="bar-text">HP 1200 / 1200</div></div>
            <div class="bar-container"><div id="mp-f" class="bar-fill" style="background:var(--mp);"></div><div class="bar-text">MP 450 / 450</div></div>
            <div class="bar-container" style="height:4px; margin-top:10px;"><div id="ex-f" class="bar-fill" style="background:var(--exp); width:35%;"></div></div>
        </div>

        <div id="side-window" class="window">
            <div class="tabs">
                <div class="tab-btn active" onclick="setTab('inv')">BAG</div>
                <div class="tab-btn" onclick="setTab('stats')">STATS</div>
                <div class="tab-btn" onclick="setTab('social')">SOCIAL</div>
            </div>
            <div id="tab-inv" class="tab-content">
                <div class="inv-grid" id="inv-g"></div>
                <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px; font-size:11px;">
                    <span style="color:var(--gold);">Gold:</span> <span id="p-gold">15,402</span>
                </div>
            </div>
            <div id="tab-stats" class="tab-content" style="display:none; font-size:12px; line-height:2;">
                STR: 45 <br> DEX: 30 <br> INT: 15 <br> DEF: 110
            </div>
        </div>

        <div id="chat-wrapper">
            <div id="chat-log"></div>
            <input type="text" id="chat-input" placeholder="Type message and press Enter...">
        </div>

        <div id="action-bar">
            <div class="skill active">‚öîÔ∏è<div class="hotkey">1</div><div id="cd-1" class="cooldown"></div></div>
            <div class="skill">üî•<div class="hotkey">2</div><div id="cd-2" class="cooldown"></div></div>
            <div class="skill">‚ùÑÔ∏è<div class="hotkey">3</div><div id="cd-3" class="cooldown"></div></div>
            <div class="skill">üß™<div class="hotkey">4</div><div id="cd-4" class="cooldown"></div></div>
        </div>

        <div id="notification">LEVEL UP!</div>
    </div>
</div>

<script>
/**
 * LAWL MMORPG ENGINE v2.0
 * FULL INTEGRATION: MAP, ENTITIES, FX, LIGHTING, UI, STATS, CHAT.
 * PRESERVING ALL PREVIOUS LOGIC.
 */

const W = 854, H = 480, TILE = 32;
const canvases = ['map', 'entities', 'fx', 'lighting'];
const ctx = {};
canvases.forEach(id => {
    const c = document.getElementById('c-'+id);
    c.width = W; c.height = H;
    ctx[id] = c.getContext('2d');
});

// -- WORLD STATE --
const world = {
    map: [], mobs: [], items: [], particles: [],
    width: 100, height: 100, time: 0, shake: 0,
    camera: { x: 1600, y: 1600 }
};

const player = {
    x: 1600, y: 1600, tx: 1600, ty: 1600,
    speed: 4, name: "S8N_WARRIOR", moving: false,
    hp: 1200, maxHp: 1200, mp: 450, maxMp: 450,
    inventory: ["üó°Ô∏è", "üõ°Ô∏è", "üçé", "ü™µ", "üíé"],
    bubble: "", bubbleTime: 0
};

// -- INITIALIZATION --
function init() {
    for(let y=0; y<world.height; y++) {
        world.map[y] = [];
        for(let x=0; x<world.width; x++) {
            let r = Math.random();
            // 0: Grass, 1: Wall, 2: Water, 3: Resource
            let type = (x==0 || y==0 || x==99 || y==99) ? 1 : (r > 0.98 ? 1 : (r < 0.05 ? 2 : (r > 0.99 ? 3 : 0)));
            world.map[y][x] = type;
            if(type === 0 && Math.random() > 0.995) {
                world.mobs.push({ x: x*TILE, y: y*TILE, hp: 100, maxHp: 100, name: "Skeletal Guard", frame: 0 });
            }
        }
    }
    renderInventory();
    addMsg("System", "Welcome to Lawl S8N Edition! Move with WASD.");
}

function renderInventory() {
    const grid = document.getElementById('inv-g');
    grid.innerHTML = "";
    for(let i=0; i<20; i++) {
        const slot = document.createElement('div');
        slot.className = 'slot';
        if(player.inventory[i]) slot.innerText = player.inventory[i];
        grid.appendChild(slot);
    }
}

function setTab(tab) {
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-'+tab).style.display = 'block';
    event.target.classList.add('active');
}

function addMsg(user, text) {
    const log = document.getElementById('chat-log');
    log.innerHTML += `<div><span style="color:var(--gold)">${user}:</span> ${text}</div>`;
    log.scrollTop = log.scrollHeight;
}

function spawnFX(x, y, color) {
    for(let i=0; i<8; i++) {
        world.particles.push({
            x, y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5,
            life: 30, color: color
        });
    }
}

// -- MAIN LOOP --
function update() {
    world.time += 0.01;
    if(world.shake > 0) world.shake *= 0.9;

    // Player Movement (Smooth Grid-Based)
    if(!player.moving) {
        let dx = 0, dy = 0;
        if(keys['w']) dy = -1; else if(keys['s']) dy = 1;
        else if(keys['a']) dx = -1; else if(keys['d']) dx = 1;

        if(dx !== 0 || dy !== 0) {
            let nx = (player.x / TILE) + dx;
            let ny = (player.y / TILE) + dy;
            if(world.map[ny][nx] === 0 || world.map[ny][nx] === 3) {
                player.tx = nx * TILE; player.ty = ny * TILE; player.moving = true;
            }
        }
    } else {
        player.x += (player.tx - player.x) * 0.2;
        player.y += (player.ty - player.y) * 0.2;
        if(Math.abs(player.x - player.tx) < 1) {
            player.x = player.tx; player.y = player.ty; player.moving = false;
        }
    }

    world.camera.x = player.x - W/2;
    world.camera.y = player.y - H/2;

    // Entities AI & Particles
    world.mobs.forEach(m => {
        if(Math.hypot(player.x-m.x, player.y-m.y) < 120) {
            m.x += (player.x - m.x) * 0.01;
            m.y += (player.y - m.y) * 0.01;
        }
    });
    world.particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.life--;
        if(p.life <= 0) world.particles.splice(i, 1);
    });
    if(player.bubbleTime > 0) player.bubbleTime--;
}

function draw() {
    Object.values(ctx).forEach(c => c.clearRect(0,0,W,H));

    const cx = world.camera.x + (Math.random()*world.shake);
    const cy = world.camera.y + (Math.random()*world.shake);

    // 1. Map Layer
    ctx.map.save();
    ctx.map.translate(-cx, -cy);
    for(let y = Math.floor(cy/TILE); y < Math.ceil((cy+H)/TILE); y++) {
        for(let x = Math.floor(cx/TILE); x < Math.ceil((cx+W)/TILE); x++) {
            if(!world.map[y] || world.map[y][x] === undefined) continue;
            let t = world.map[y][x];
            ctx.map.fillStyle = t==0 ? "#1e272e" : (t==1 ? "#000" : (t==2 ? "#0984e3" : "#2f3542"));
            ctx.map.fillRect(x*TILE, y*TILE, TILE, TILE);
            if(t==2) { // Water shimmer
                ctx.map.fillStyle = "rgba(255,255,255,0.1)";
                ctx.map.fillRect(x*TILE + Math.sin(world.time + x)*4, y*TILE + Math.cos(world.time + y)*4, 2, 2);
            }
        }
    }
    ctx.map.restore();

    // 2. Entity Layer (Depth Sort)
    ctx.entities.save();
    ctx.entities.translate(-cx, -cy);
    const sorted = [...world.mobs, player].sort((a,b) => a.y - b.y);
    sorted.forEach(e => {
        if(e.name === player.name) {
            ctx.entities.fillStyle = "gold";
            ctx.entities.fillRect(e.x+4, e.y+4, 24, 24);
            ctx.entities.fillStyle = "white"; ctx.entities.font = "bold 10px Arial";
            ctx.entities.textAlign = "center";
            ctx.entities.fillText(e.name, e.x+16, e.y-10);
            if(player.bubbleTime > 0) {
                ctx.entities.fillStyle = "white"; ctx.entities.fillRect(e.x-20, e.y-45, 70, 18);
                ctx.entities.fillStyle = "black"; ctx.entities.fillText(player.bubble, e.x+15, e.y-32);
            }
        } else {
            ctx.entities.fillStyle = "#ff4757";
            ctx.entities.fillRect(e.x+6, e.y+6, 20, 20);
        }
    });
    ctx.entities.restore();

    // 3. FX Layer
    ctx.fx.save();
    ctx.fx.translate(-cx, -cy);
    world.particles.forEach(p => {
        ctx.fx.fillStyle = p.color;
        ctx.fx.globalAlpha = p.life / 30;
        ctx.fx.fillRect(p.x, p.y, 3, 3);
    });
    ctx.fx.restore();

    // 4. Lighting Layer
    const cycle = (Math.sin(world.time * 0.1) + 1) / 2; // 0 to 1
    ctx.lighting.fillStyle = `rgba(0,0,25,${0.4 + cycle * 0.5})`;
    ctx.lighting.fillRect(0,0,W,H);
    
    let g = ctx.lighting.createRadialGradient(W/2, H/2, 0, W/2, H/2, 220);
    g.addColorStop(0, "rgba(255,255,255,1)");
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.lighting.globalCompositeOperation = 'destination-out';
    ctx.lighting.fillStyle = g;
    ctx.lighting.beginPath(); ctx.lighting.arc(W/2, H/2, 220, 0, Math.PI*2); ctx.lighting.fill();
    ctx.lighting.globalCompositeOperation = 'source-over';
}

// -- INPUTS --
const keys = {};
window.onkeydown = e => {
    keys[e.key.toLowerCase()] = true;
    if(e.key === 'i') {
        const win = document.getElementById('side-window');
        win.style.display = win.style.display === 'block' ? 'none' : 'block';
    }
    if(e.key === 'Enter') {
        const input = document.getElementById('chat-input');
        if(document.activeElement === input && input.value) {
            player.bubble = input.value; player.bubbleTime = 180;
            addMsg(player.name, input.value);
            input.value = ""; input.blur();
        } else input.focus();
    }
    if(e.key === '1') { world.shake = 10; spawnFX(player.x+16, player.y+16, "orange"); }
};
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

init();
function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
