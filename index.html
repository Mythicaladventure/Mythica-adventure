const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');
const stick = document.getElementById('joystick-stick');
const area = document.getElementById('joystick-area');

const imgPlayer = new Image(); imgPlayer.src = 'player.png';
const imgFloor = new Image(); imgFloor.src = 'floor1.png';

// VARIABLES DEL MUNDO (MMORPG)
let world = { width: 2000, height: 2000 }; // Un mapa mucho más grande
let camera = { x: 0, y: 0 };

// JUGADOR (Regla: Nivel 1 = 350 HP)
let player = {
    x: world.width / 2,
    y: world.height / 2,
    level: 1,
    hp: 350, 
    maxHp: 350,
    mp: 100,
    maxMp: 100,
    speed: 5
};

let moveDir = { x: 0, y: 0 };

function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

// Lógica de Joystick (Misma que ya tienes)
area.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = area.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    let dx = touch.clientX - centerX;
    let dy = touch.clientY - centerY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    const maxDist = 40;
    if (dist > maxDist) { dx *= maxDist / dist; dy *= maxDist / dist; }
    stick.style.transform = `translate(${dx}px, ${dy}px)`;
    moveDir.x = dx / maxDist; moveDir.y = dy / maxDist;
});

area.addEventListener('touchend', () => {
    stick.style.transform = `translate(0, 0)`;
    moveDir = { x: 0, y: 0 };
});

function draw() {
    // 1. LÓGICA DE CÁMARA: Mantener al jugador centrado
    camera.x = player.x - canvas.width / 2;
    camera.y = player.y - canvas.height / 2;

    ctx.fillStyle = "#111"; // Fondo oscuro fuera del mapa
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(-camera.x, -camera.y); // Mover todo el mundo según la cámara

    // 2. DIBUJAR SUELO (Repetido en todo el mundo de 2000x2000)
    if (imgFloor.complete) {
        for(let i=0; i < world.width; i += 40) {
            for(let j=0; j < world.height; j += 40) {
                ctx.drawImage(imgFloor, i, j, 40, 40);
            }
        }
    }

    // 3. MOVIMIENTO
    player.x += moveDir.x * player.speed;
    player.y += moveDir.y * player.speed;

    // Límites del mundo para no salirse
    player.x = Math.max(0, Math.min(player.x, world.width));
    player.y = Math.max(0, Math.min(player.y, world.height));

    // 4. DIBUJAR JUGADOR
    if (imgPlayer.complete) {
        ctx.drawImage(imgPlayer, player.x - 20, player.y - 20, 40, 40);
    }

    // 5. BARRAS (350 HP Nivel 1)
    const barY = player.y - 45;
    ctx.fillStyle = "#222";
    ctx.fillRect(player.x - 20, barY, 40, 6); // Fondo
    ctx.fillStyle = "#ff4757";
    ctx.fillRect(player.x - 20, barY, (player.hp / player.maxHp) * 40, 6); // Salud
    
    ctx.fillStyle = "#2e86de";
    ctx.fillRect(player.x - 20, barY + 8, (player.mp / player.maxMp) * 40, 4); // Maná

    ctx.restore(); // Terminar el efecto de la cámara

    requestAnimationFrame(draw);
}

window.addEventListener('resize', init);
init();
draw();
