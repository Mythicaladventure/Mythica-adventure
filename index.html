<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mythica Apex: Divine Unification</title>
    <style>
        :root {
            --glass: rgba(10, 10, 18, 0.96);
            --gold: #ffd700; --silver: #c0c0c0; --gem: #ff00ff;
            --hp: #00ff66; --mp: #00ccff; --neon: #3e93ff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: #fff; user-select: none; }

        /* UI NUCLEO */
        .glass { background: var(--glass); backdrop-filter: blur(30px); border: 1px solid rgba(255,255,255,0.12); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; display: none; }
        .hud-el { position: absolute; pointer-events: auto; padding: 15px; }

        /* HUD Y MAPA */
        #top-hud { top: 20px; left: 20px; width: 240px; }
        .bar-bg { width: 100%; height: 10px; background: rgba(0,0,0,0.6); border-radius: 10px; margin: 6px 0; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.4s; }
        .currency { display: flex; gap: 12px; font-size: 11px; font-weight: bold; margin-top: 8px; }
        #map-tag { position: absolute; top: 20px; right: 20px; color: var(--neon); font-size: 14px; font-weight: bold; text-shadow: 0 0 10px var(--neon); }

        /* BLOQUE 44: CHAT SISTEMA */
        #chat-container { position: absolute; bottom: 120px; left: 20px; width: 260px; height: 150px; display: flex; flex-direction: column; pointer-events: auto; }
        #chat-box { flex: 1; overflow-y: auto; font-size: 12px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; margin-bottom: 5px; color: #aaa; }
        #chat-input { background: rgba(255,255,255,0.1); border: none; padding: 10px; border-radius: 8px; color: #fff; width: 100%; }
        .msg-me { color: var(--neon); } .msg-sys { color: var(--gold); font-style: italic; }

        /* MENUS */
        #main-menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 92%; height: 85%; z-index: 1000; display: none; flex-direction: column; pointer-events: auto; }
        .tabs { display: flex; background: rgba(0,0,0,0.3); border-radius: 20px 20px 0 0; }
        .tab { flex: 1; padding: 15px; text-align: center; font-size: 10px; font-weight: bold; cursor: pointer; }
        .tab.active { color: var(--gold); border-bottom: 3px solid var(--gold); }
        .view { flex: 1; padding: 20px; overflow-y: auto; display: none; }
        .view.active { display: block; }

        /* BLOQUE 43: TIENDA Y ANUNCIOS */
        .shop-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        .btn-buy { background: var(--gem); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-ad { background: linear-gradient(45deg, #00f, #f0f); color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: bold; margin-bottom: 20px; box-shadow: 0 0 15px rgba(255,0,255,0.4); }

        /* CONTROLES */
        #actions { position: absolute; bottom: 30px; right: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; pointer-events: auto; }
        .btn-c { width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 2px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5); }
        .btn-atk { background: radial-gradient(#900, #300); border-color: #f55; }
        #joy-base { position: absolute; bottom: 40px; left: 300px; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border-radius: 50%; pointer-events: auto; }
        #joy-knob { position: absolute; width: 40px; height: 40px; background: #fff; border-radius: 50%; top: 30px; left: 300px; box-shadow: 0 0 20px var(--neon); pointer-events: none; }

        canvas { display: block; }
    </style>
</head>
<body>

<div id="login-screen" style="position:fixed; inset:0; background:#000; z-index:9000; display:flex; align-items:center; justify-content:center;">
    <div class="glass" style="padding:50px; text-align:center; width:320px;">
        <h1 style="color:var(--gold); margin:0; letter-spacing:4px;">MYTHICA</h1>
        <p style="font-size:10px; opacity:0.5; margin-bottom:30px;">THE DIVINE UNIFICATION</p>
        <input type="text" id="user-id" placeholder="NOMBRE DE HÃ‰ROE" style="width:100%; padding:12px; background:rgba(255,255,255,0.1); border:1px solid #444; color:#fff; border-radius:8px; margin-bottom:15px; text-align:center;">
        <button onclick="initGame()" style="width:100%; padding:15px; background:var(--gold); border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ENTRAR AL NEXUS</button>
    </div>
</div>

<div id="ui-layer">
    <div id="top-hud" class="hud-el glass">
        <div id="p-tag" style="font-weight:bold; color:var(--gold);">PLAYER</div>
        <div class="bar-bg"><div id="hp-f" class="bar-fill" style="background:var(--hp);"></div></div>
        <div class="bar-bg"><div id="mp-f" class="bar-fill" style="background:var(--mp);"></div></div>
        <div class="currency">
            <span style="color:var(--silver)">S: <span id="s-val">0</span></span>
            <span style="color:var(--gold)">G: <span id="g-val">0</span></span>
            <span style="color:var(--gem)">ðŸ’Ž: <span id="d-val">0</span></span>
        </div>
    </div>
    
    <div id="map-tag">NEON CITY</div>

    <div id="chat-container" class="glass" style="background:rgba(0,0,0,0.5); padding:10px;">
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="Escribe al mundo..." onkeypress="if(event.key==='Enter') sendChat()">
    </div>

    <div id="actions">
        <div class="btn-c glass" onclick="castHeal()">HEAL</div>
        <div class="btn-c btn-atk" onclick="doAttack()">ATK</div>
        <div class="btn-c glass" onclick="toggleMenu('v-shop')">SHOP</div>
        <div class="btn-c glass" onclick="toggleMenu('v-skills')">MENU</div>
    </div>

    <div id="joy-base"></div>
    <div id="joy-knob"></div>
</div>

<div id="main-menu" class="glass">
    <div class="tabs">
        <div class="tab" onclick="showTab('skills')">PODER</div>
        <div class="tab" onclick="showTab('shop')">TIENDA ðŸ’Ž</div>
        <div class="tab" onclick="showTab('clan')">CLAN</div>
        <div class="tab" onclick="showTab('cloud')">CLOUD</div>
    </div>
    
    <div id="v-skills" class="view active"></div>
    
    <div id="v-shop" class="view">
        <button class="btn-ad" onclick="watchAd()">ðŸ“º VER VIDEO (RECOMPENSA: 1-3 ðŸ’Ž)</button>
        <h4 style="color:var(--gold); margin-top:0;">PAQUETES DE GEMAS</h4>
        <div class="shop-card">
            <span>Bolsa de Gemas (x50)</span>
            <button class="btn-buy" onclick="buyGems(50, 1.99)">$1.99</button>
        </div>
        <div class="shop-card">
            <span>Cofre Arcano (x500)</span>
            <button class="btn-buy" onclick="buyGems(500, 9.99)">$9.99</button>
        </div>
        <div class="shop-card">
            <span>Legado Mythica (x2000)</span>
            <button class="btn-buy" onclick="buyGems(2000, 24.99)">$24.99</button>
        </div>
    </div>

    <div id="v-clan" class="view">
        <button class="btn-ad" style="background:var(--neon)" onclick="createClan()">FUNDAR CLAN (1000 ORO)</button>
    </div>
    
    <div id="v-cloud" class="view">
        <button onclick="saveToCloud()" class="btn-ad" style="background:var(--hp)">GUARDAR PROGRESO</button>
        <button onclick="loadFromCloud()" class="btn-ad" style="background:var(--gold); color:black;">CARGAR PROGRESO</button>
    </div>
</div>

<canvas id="stage"></canvas>

<script>
    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d');
    
    let p = {
        name: "", x: 2500, y: 2500, hp: 100, mHp: 100, mp: 50, mMp: 50,
        wallet: { s: 0, g: 0, d: 5 },
        clan: null, currentMap: "Neon City",
        tree: { atk: { n: "DaÃ±o NeÃ³n", l: 0 }, mag: { n: "ManÃ¡ Arcano", l: 0 } },
        chatMsg: "", chatTime: 0
    };

    const MAPS = {
        "Neon City": { c: "#06060a", portal: {x:2800, y:2800, to: "Crystal Desert"} },
        "Crystal Desert": { c: "#110a05", portal: {x:2200, y:2200, to: "Biomech Forest"} },
        "Biomech Forest": { c: "#051105", portal: {x:2500, y:2800, to: "Neon City"} }
    };

    let mobs = [], loot = [], fx = [], move = {x:0, y:0}, active = false;

    function initGame() {
        p.name = document.getElementById('user-id').value || "HÃ©roe";
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'block';
        active = true;
        resize();
        addChat("Sistema", "Â¡Bienvenido a Mythica Apex!", "msg-sys");
        for(let i=0; i<8; i++) spawnMob();
        loop();
    }

    // BLOQUE 44: LÃ“GICA DE CHAT
    function sendChat() {
        let input = document.getElementById('chat-input');
        if(input.value.trim() === "") return;
        addChat(p.name, input.value);
        p.chatMsg = input.value;
        p.chatTime = 180; // Segundos de frames que dura el mensaje sobre la cabeza
        input.value = "";
    }

    function addChat(user, msg, type = "msg-me") {
        let box = document.getElementById('chat-box');
        box.innerHTML += `<div class="${type}"><b>${user}:</b> ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    // BLOQUE 43: MONETIZACIÃ“N (SIMULADA)
    function watchAd() {
        alert("Reproduciendo Anuncio... (SimulaciÃ³n de 30s)");
        setTimeout(() => {
            let reward = Math.floor(Math.random() * 3) + 1;
            p.wallet.d += reward;
            addChat("Sistema", `Â¡Anuncio visto! Recibiste ${reward} Gemas ðŸ’Ž`, "msg-sys");
            updateHUD();
        }, 1000);
    }

    function buyGems(amt, price) {
        if(confirm(`Â¿Comprar ${amt} Gemas por $${price}?`)) {
            p.wallet.d += amt;
            updateHUD();
            addChat("Tienda", `Gracias por tu compra de ${amt} gemas.`, "msg-sys");
        }
    }

    function loop() {
        if(!active) return;
        update();
        draw();
        requestAnimationFrame(loop);
    }

    function update() {
        p.x += move.x * 6; p.y += move.y * 6;
        if(p.chatTime > 0) p.chatTime--;

        let m = MAPS[p.currentMap];
        if(Math.hypot(p.x - m.portal.x, p.y - m.portal.y) < 50) {
            p.currentMap = m.portal.to;
            p.x = 2500; p.y = 2500;
            mobs = []; spawnMob();
            document.getElementById('map-tag').innerText = p.currentMap.toUpperCase();
        }

        loot.forEach((it, i) => {
            let d = Math.hypot(p.x - it.x, p.y - it.y);
            if(d < 150) {
                it.x += (p.x - it.x) * 0.2; it.y += (p.y - it.y) * 0.2;
                if(d < 15) {
                    p.wallet.s += it.v;
                    if(p.wallet.s >= 100) { p.wallet.g++; p.wallet.s -= 100; }
                    loot.splice(i, 1);
                }
            }
        });
        updateHUD();
    }

    function draw() {
        let m = MAPS[p.currentMap];
        ctx.fillStyle = m.c; ctx.fillRect(0,0,canvas.width, canvas.height);
        let cx = p.x - canvas.width/2, cy = p.y - canvas.height/2;

        ctx.save(); ctx.translate(-cx, -cy);
        
        // Portal
        ctx.fillStyle = "#3e93ff"; ctx.shadowBlur = 20; ctx.shadowColor = "#3e93ff";
        ctx.beginPath(); ctx.arc(m.portal.x, m.portal.y, 40, 0, Math.PI*2); ctx.fill();

        // Mobs y Loot
        mobs.forEach(mob => {
            ctx.fillStyle = "#f44"; ctx.beginPath(); ctx.roundRect(mob.x-15, mob.y-15, 30, 30, 5); ctx.fill();
        });
        loot.forEach(l => {
            ctx.fillStyle = "#c0c0c0"; ctx.beginPath(); ctx.arc(l.x, l.y, 4, 0, Math.PI*2); ctx.fill();
        });

        // Jugador
        ctx.fillStyle = "#fff"; ctx.shadowBlur = 25; ctx.shadowColor = "#3e93ff";
        ctx.beginPath(); ctx.roundRect(p.x-18, p.y-18, 36, 36, 10); ctx.fill();
        
        // Bloque 44: Mensaje sobre la cabeza
        if(p.chatTime > 0) {
            ctx.shadowBlur = 0; ctx.fillStyle = "rgba(0,0,0,0.7)";
            ctx.beginPath(); ctx.roundRect(p.x-50, p.y-70, 100, 25, 5); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.font = "10px Arial"; ctx.textAlign = "center";
            ctx.fillText(p.chatMsg, p.x, p.y-54);
        }

        ctx.restore();
        drawFX(cx, cy);
    }

    function doAttack() {
        mobs.forEach(m => {
            if(Math.hypot(p.x-m.x, p.y-m.y) < 100) {
                m.hp -= (20 + p.tree.atk.l * 5);
                pop(m.x, m.y, "#f44", "-DMG");
                if(m.hp <= 0) {
                    loot.push({x: m.x, y: m.y, v: 25}); // Solo Plata
                    mobs = mobs.filter(mob => mob !== m); spawnMob();
                }
            }
        });
    }

    function updateHUD() {
        document.getElementById('hp-f').style.width = (p.hp/p.mHp*100) + "%";
        document.getElementById('mp-f').style.width = (p.mp/p.mMp*100) + "%";
        document.getElementById('s-val').innerText = p.wallet.s;
        document.getElementById('g-val').innerText = p.wallet.g;
        document.getElementById('d-val').innerText = p.wallet.d;
        document.getElementById('p-tag').innerText = p.name.toUpperCase();
    }

    // UTILS Y JOYSTICK
    function spawnMob() { mobs.push({x: 2300+Math.random()*400, y: 2300+Math.random()*400, hp: 50}); }
    function pop(x, y, c, t) { fx.push({x, y, c, t, l:1}); }
    function drawFX(cx, cy) {
        ctx.save(); ctx.translate(-cx, -cy);
        fx.forEach((f, i) => {
            ctx.globalAlpha = f.l; ctx.fillStyle = f.c; ctx.font = "bold 14px Arial";
            ctx.fillText(f.t, f.x, f.y); f.y -= 1; f.l -= 0.02;
            if(f.l <= 0) fx.splice(i, 1);
        });
        ctx.restore();
    }

    // Joystick Adaptado
    const jb = document.getElementById('joy-base'), jk = document.getElementById('joy-knob');
    window.addEventListener('touchmove', e => {
        let touch = e.touches[0];
        let dx = touch.clientX - 350, dy = touch.clientY - (window.innerHeight - 90);
        let d = Math.hypot(dx, dy); if(d>40){ dx*=40/d; dy*=40/d; }
        jk.style.left = (300+30+dx)+'px'; jk.style.top = (window.innerHeight - 90 + dy)+'px';
        move = {x:dx/40, y:dy/40};
    });
    window.addEventListener('touchend', () => { move={x:0, y:0}; jk.style.left='330px'; jk.style.top=(window.innerHeight-90)+'px'; });

    function toggleMenu(tab = 'v-skills') {
        let m = document.getElementById('main-menu');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        showTab(tab.replace('v-', ''));
    }

    function showTab(t) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('v-'+t).classList.add('active');
        if(t === 'skills') renderSkills();
    }

    function renderSkills() {
        let h = "";
        for(let k in p.tree) {
            let s = p.tree[k];
            h += `<div class="shop-card">
                <b>${s.n} (Nivel ${s.l})</b>
                <button class="btn-buy" onclick="p.tree['${k}'].l++; renderSkills();">SUBIR (10 G)</button>
            </div>`;
        }
        document.getElementById('v-skills').innerHTML = h;
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize;
</script>
</body>
</html>
