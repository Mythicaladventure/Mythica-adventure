<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Mythical Adventure - MMORPG</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* === ESTILOS DEL JUEGO (Dark Fantasy) === */
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Lato', sans-serif; color: white; }

        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* PANTALLA DE LOGIN */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a0b00 0%, #000000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 5000; transition: opacity 0.5s;
        }

        .game-logo {
            font-family: 'Cinzel', serif; color: #ffcc00; 
            text-shadow: 0 0 15px #ff6600, 0 4px 0 #331100; 
            font-size: 3rem; margin-bottom: 10px; text-align: center;
        }

        .login-container {
            background: rgba(20, 20, 20, 0.95); border: 1px solid #444; border-top: 2px solid #ffcc00;
            padding: 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 15px;
        }

        input { 
            background: #111; border: 1px solid #555; color: #fff; padding: 12px; 
            font-size: 16px; border-radius: 4px; text-align: center; width: 100%;
            font-family: 'Cinzel', serif;
        }
        input:focus { border-color: #ffcc00; outline: none; }

        .class-selector { display: flex; gap: 8px; justify-content: center; }
        .class-card {
            width: 70px; height: 90px; background: #222; border: 1px solid #444;
            border-radius: 6px; cursor: pointer; display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative;
        }
        .class-card.selected { border-color: #ffcc00; background: linear-gradient(180deg, #3a2a00, #1a1a00); }
        .class-icon { font-size: 28px; margin-bottom: 5px; }
        .class-name { font-size: 9px; color: #aaa; text-transform: uppercase; font-weight: bold; }
        .class-card.selected .class-name { color: #fff; }

        #class-stats { font-size: 12px; color: #ccc; height: 40px; display: flex; flex-direction: column; justify-content: center; }
        .stat-bar-container { display: flex; align-items: center; gap: 5px; margin: 2px 0; }
        .stat-track { flex-grow: 1; height: 4px; background: #333; border-radius: 2px; }
        .stat-val { height: 100%; border-radius: 2px; transition: width 0.3s ease; }

        #start-btn {
            background: linear-gradient(90deg, #880000, #cc0000); color: white; border: none;
            padding: 15px; font-size: 16px; font-weight: bold; border-radius: 4px; cursor: pointer; 
            font-family: 'Cinzel', serif; border: 1px solid #ff4444; transition: all 0.3s;
        }
        #start-btn:disabled { background: #444; border-color: #666; cursor: wait; opacity: 0.7; }

        /* UI JUEGO */
        #game-ui { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        #game-ui > * { pointer-events: auto; }
        
        .player-profile {
            position: absolute; top: 10px; left: 10px; display: flex; align-items: center; gap: 8px;
            background: rgba(0,0,0,0.6); padding: 5px; border-radius: 30px; border: 1px solid #444;
        }
        .avatar-frame { width: 48px; height: 48px; border-radius: 50%; border: 2px solid #ffd700; background: #111; overflow: hidden; }
        .bars { width: 120px; display: flex; flex-direction: column; gap: 3px; }
        .bar-container { height: 10px; background: #222; position: relative; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .hp-fill { background: #d32f2f; } .mp-fill { background: #1976d2; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 8px; top: 0; text-shadow: 1px 1px 0 #000; }

        #chat-system { position: absolute; bottom: 90px; left: 15px; width: 280px; display: flex; flex-direction: column; gap: 5px; pointer-events: none; }
        #chat-log { height: 100px; overflow-y: scroll; background: linear-gradient(0deg, rgba(0,0,0,0.8), transparent); padding: 5px; display: flex; flex-direction: column-reverse; pointer-events: auto; }
        .chat-msg { font-size: 11px; margin-bottom: 2px; text-shadow: 1px 1px 0 #000; }
        .msg-sys { color: #ffff00; } .msg-player { color: #ffffff; }
        .chat-input-row { display: flex; gap: 5px; pointer-events: auto; }
        #chat-input { background: rgba(0,0,0,0.6); border: 1px solid #555; color: white; flex-grow: 1; padding: 5px; border-radius: 4px; }
        #chat-send { background: #444; color: white; border: 1px solid #666; width: 30px; cursor: pointer; }

        .action-bar { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; align-items: flex-end; }
        .action-slot { position: relative; width: 55px; height: 55px; }
        .btn { width: 100%; height: 100%; border-radius: 12px; border: 2px solid #666; background: radial-gradient(circle, #333, #111); color: white; font-size: 24px; }
        .attack-btn { width: 75px; height: 75px; border-color: #aa0000; background: radial-gradient(circle, #550000, #220000); font-size: 32px; }
        .hotkey-label { position: absolute; top: -8px; left: 50%; transform: translateX(-50%); background: #000; border: 1px solid #444; font-size: 8px; padding: 1px 4px; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="game-container"></div>

    <div id="login-screen">
        <div class="game-logo">MYTHICAL<br>ADVENTURE</div>
        <div class="login-container">
            <input type="text" id="username-input" placeholder="Nombre del H√©roe" maxlength="12">
            
            <div class="class-selector">
                <div class="class-card selected" onclick="selectClass('knight', this)"><div class="class-icon">üõ°Ô∏è</div><div class="class-name">Knight</div></div>
                <div class="class-card" onclick="selectClass('mage', this)"><div class="class-icon">üî•</div><div class="class-name">Mage</div></div>
                <div class="class-card" onclick="selectClass('paladin', this)"><div class="class-icon">üèπ</div><div class="class-name">Paladin</div></div>
                <div class="class-card" onclick="selectClass('healer', this)"><div class="class-icon">‚ú®</div><div class="class-name">Healer</div></div>
            </div>

            <div id="class-stats">
                <div class="stat-bar-container"><span class="stat-label">VIDA</span><div class="stat-track"><div class="stat-val" id="stat-hp" style="width: 95%; background: #d32f2f;"></div></div></div>
                <div class="stat-bar-container"><span class="stat-label">MAN√Å</span><div class="stat-track"><div class="stat-val" id="stat-mp" style="width: 20%; background: #1976d2;"></div></div></div>
            </div>

            <button id="start-btn" onclick="startGame()">ENTRAR AL MUNDO</button>
            <p style="color: #666; font-size: 10px; margin: 0; text-align: center;">Estado: Online | v1.2.2 Pro</p>
        </div>
    </div>

    <div id="game-ui">
        <div class="player-profile">
            <div class="avatar-frame"><img src="client/assets/sprites/otsp_creatures_01.png" id="ui-avatar" style="object-fit: none; object-position: 0 0;"></div>
            <div class="bars">
                <div class="bar-container"><div class="bar-text" id="hp-text">100/100</div><div class="bar-fill hp-fill" id="hp-bar" style="width: 100%"></div></div>
                <div class="bar-container"><div class="bar-text" id="mp-text">50/50</div><div class="bar-fill mp-fill" id="mp-bar" style="width: 100%"></div></div>
            </div>
        </div>
        <div id="chat-system">
            <div id="chat-log"><div class="chat-msg msg-sys">Bienvenido a Mythical Adventure.</div></div>
            <div class="chat-input-row"><input type="text" id="chat-input" placeholder="Chat..."><button id="chat-send" onclick="sendChat()">‚û§</button></div>
        </div>
        <div class="action-bar">
            <div class="action-slot"><span class="hotkey-label">HEAL</span><button class="btn" onclick="emitAction('HEAL')">üíä</button></div>
            <div class="action-slot"><span class="hotkey-label">FIRE</span><button class="btn" onclick="emitAction('SPELL_1')">üî•</button></div>
            <div class="action-slot" style="width: 75px; height: 75px;"><span class="hotkey-label">ATK</span><button class="btn attack-btn" onclick="emitAction('ATTACK')">‚öîÔ∏è</button></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/colyseus.js@0.15.0/dist/colyseus.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser3-rex-plugins@1.1.84/dist/rexvirtualjoystickplugin.min.js"></script>
    
    <script src="client/index.js"></script>

    <script>
        let selectedClass = 'knight';
        const stats = { knight: {hp:'95%', mp:'20%'}, mage: {hp:'40%', mp:'95%'}, paladin: {hp:'70%', mp:'60%'}, healer: {hp:'60%', mp:'80%'} };

        // DETECTOR DE ERRORES GLOBAL
        window.onerror = function(msg) {
            const btn = document.getElementById('start-btn');
            btn.innerText = "ERROR T√âCNICO";
            btn.style.background = "#550000";
            // Si el error es de constructor, avisamos espec√≠ficamente
            if(msg.includes("not a constructor")) {
                alert("Error de Librer√≠a: Se est√° corrigiendo autom√°ticamente. Refresca la p√°gina en 1 minuto.");
            } else {
                alert("Error detectado: " + msg);
            }
        };

        function selectClass(cls, el) {
            selectedClass = cls;
            document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('stat-hp').style.width = stats[cls].hp;
            document.getElementById('stat-mp').style.width = stats[cls].mp;
        }

        function startGame() {
            const name = document.getElementById('username-input').value.trim();
            if(!name) return;

            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.innerText = "DESPERTANDO SERVIDOR...";

            // Iniciar Motor
            window.dispatchEvent(new CustomEvent('start-game', { detail: { name: name, role: selectedClass } }));

            // Cuenta regresiva 60s
            let count = 60;
            const interval = setInterval(() => {
                count--;
                if(btn.disabled) btn.innerText = `CONECTANDO... (${count}s)`;
                if(count <= 0) {
                    clearInterval(interval);
                    if(document.getElementById('login-screen').style.display !== 'none') {
                        btn.disabled = false;
                        btn.innerText = "TIEMPO AGOTADO - REINTENTAR";
                        alert("El servidor tarda en despertar. ¬°Intenta de nuevo ahora que ya deber√≠a estar listo!");
                    }
                }
            }, 1000);
        }

        function emitAction(t) { window.dispatchEvent(new CustomEvent('game-action', { detail: t })); }
        function sendChat() {
            const i = document.getElementById('chat-input');
            if(i.value.trim()) { window.dispatchEvent(new CustomEvent('game-action', { detail: i.value })); i.value = ''; }
        }

        // Helpers globales
        window.addLogMessage = (msg, type='msg-sys') => {
            const log = document.getElementById('chat-log');
            log.innerHTML = `<div class="chat-msg ${type}">${msg}</div>` + log.innerHTML;
        };
        window.resetLogin = () => {
            const btn = document.getElementById('start-btn');
            btn.disabled = false; btn.innerText = "ENTRAR";
        };
    </script>
</body>
</html>
