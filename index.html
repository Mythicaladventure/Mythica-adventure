<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mythica Adventure: Genesis Engine (Mobile)</title>
    <style>
        :root {
            --bg-dark: #0a0a0a; --ui-panel: #282828; --ui-border: #444;
            --gold: #d4af37; --hp-green: #2ecc71; --mp-blue: #3498db;
            --font-main: 'Verdana', sans-serif;
            --hp-mob: #e74c3c;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: var(--font-main); color: #eee; background: var(--bg-dark); }

        /* --- LAYOUT GLOBAL MÓVIL --- */
        #game-wrapper { display: flex; flex-direction: column; width: 100vw; height: 100vh; }
        
        /* --- GAME CANVAS CONTAINER --- */
        #game-container { flex: 1; position: relative; background: var(--bg-dark); display: flex; justify-content: center; align-items: center; }
        #mythicaCanvas { image-rendering: pixelated; max-width: 800px; max-height: 600px; border: 2px solid var(--ui-border); box-shadow: 0 0 15px rgba(0,0,0,0.6); }

        /* --- UI INFERIOR (SIDEBAR REACTIVO) --- */
        #mobile-ui { height: 260px; background: var(--ui-panel); border-top: 3px solid var(--bg-dark); display: flex; flex-direction: column; z-index: 100; }
        
        /* Tabs de Navegación */
        .ui-tabs { display: flex; background: #1a1a1a; height: 38px; border-bottom: 1px solid #111; }
        .ui-tab { flex: 1; display: flex; justify-content: center; align-items: center; font-size: 10px; font-weight: bold; color: #888; border-right: 1px solid #222; }
        .ui-tab.active { background: var(--ui-panel); color: var(--gold); border-bottom: none; }

        /* Contenido del Panel */
        #tab-content { flex: 1; display: flex; overflow: hidden; }
        
        /* Sección de Equipamiento */
        .equipment-panel { width: 120px; border-right: 2px solid var(--bg-dark); padding: 8px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }
        .eq-slot { background: #333; border: 1px solid var(--ui-border); aspect-ratio: 1; display: flex; justify-content: center; align-items: center; font-size: 8px; color: #777; position: relative; }
        .eq-slot.equipped { border-color: var(--gold); }
        .eq-item-icon { width: 80%; height: 80%; background-color: var(--gold); } /* Placeholder item */

        /* Vista de Contenedores (Mochilas) */
        .container-panel { flex: 1; padding: 5px; overflow-y: auto; background: #1f1f1f; }
        .container-header { font-size: 11px; color: var(--gold); margin-bottom: 5px; display: flex; justify-content: space-between; padding: 0 5px; }
        .item-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        .item-slot { width: 45px; height: 45px; background: #333; border: 1px solid #555; position: relative; display: flex; justify-content: center; align-items: center; }
        .item-slot.draggable { cursor: grab; }
        .item-count { position: absolute; bottom: 2px; right: 2px; font-size: 8px; color: #fff; text-shadow: 1px 1px #000; }

        /* Battle List */
        .battle-panel { flex: 1; padding: 5px; overflow-y: auto; background: #1f1f1f; }
        .mob-entry { padding: 6px; border: 1px solid #333; margin-bottom: 4px; font-size: 11px; cursor: pointer; display: flex; justify-content: space-between; }
        .mob-entry.target { border-color: var(--gold); background: #3a2a0a; color: #fff; }

        /* --- CONSOLA DE MENSAJES FLOTANTE --- */
        #message-log { position: absolute; bottom: 270px; left: 10px; right: 10px; height: 70px; background: rgba(0,0,0,0.7); font-size: 11px; padding: 8px; overflow-y: auto; pointer-events: none; color: #ccc; z-index: 100; }
        .log-entry span:first-child { color: var(--gold); } /* Log channel */

        /* --- BARRAS DE VIDA/MANA INFERIOR --- */
        .status-footer { height: 35px; background: #111; display: flex; align-items: center; justify-content: space-around; padding: 0 10px; border-top: 1px solid #222; }
        .bar-wrap { flex: 1; height: 18px; background: #000; border: 1px solid #555; margin: 0 5px; position: relative; border-radius: 2px; }
        .bar-fill { height: 100%; transition: width 0.3s ease-out; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 10px; font-weight: bold; top: 1px; color: #fff; text-shadow: 1px 1px #000; }

        /* --- CONTROLES DE MOVIMIENTO (DPAD) --- */
        #d-pad { position: absolute; bottom: 310px; left: 20px; width: 120px; height: 120px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; opacity: 0.7; z-index: 100; }
        .d-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; display: flex; justify-content: center; align-items: center; font-size: 18px; color: #fff; }
        .d-btn:active { background: rgba(255,255,255,0.3); }

        /* --- Botón de Ataque Central --- */
        #attack-btn { position: absolute; bottom: 350px; right: 20px; width: 60px; height: 60px; background: rgba(200,0,0,0.7); border: 2px solid #f00; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #fff; font-weight: bold; z-index: 100; }
        #attack-btn:active { background: rgba(255,0,0,0.9); }
        .cooldown-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; font-size: 16px; color: #fff; opacity: 0; transition: opacity 0.3s; }
        .cooldown-overlay.active { opacity: 1; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="game-container">
        <canvas id="mythicaCanvas"></canvas>
        <div id="message-log"></div>
        
        <div id="d-pad">
            <div></div><div class="d-btn" ontouchstart="Game.Player.move(-1)" ontouchend="Game.Player.stopMove()">▲</div><div></div>
            <div class="d-btn" ontouchstart="Game.Player.move(-1,0)" ontouchend="Game.Player.stopMove()">◀</div><div style="background:none;"></div><div class="d-btn" ontouchstart="Game.Player.move(1,0)" ontouchend="Game.Player.stopMove()">▶</div>
            <div></div><div class="d-btn" ontouchstart="Game.Player.move(0,1)" ontouchend="Game.Player.stopMove()">▼</div><div></div>
        </div>

        <div id="attack-btn" ontouchstart="Game.Combat.attackPlayerTarget()">
            ⚔️
            <div id="attack-cooldown" class="cooldown-overlay"></div>
        </div>
    </div>

    <div id="mobile-ui">
        <div class="ui-tabs">
            <div class="ui-tab active" data-tab="equipment">EQUIPMENT</div>
            <div class="ui-tab" data-tab="backpack">BACKPACK</div>
            <div class="ui-tab" data-tab="battle">BATTLE LIST</div>
            <div class="ui-tab" data-tab="skills">SKILLS</div>
            <div class="ui-tab" data-tab="options">OPTIONS</div>
        </div>
        
        <div id="tab-content">
            <div class="tab-panel active" id="equipment-panel">
                <div class="equipment-panel">
                    <div class="eq-slot" data-slot="head"></div><div class="eq-slot" data-slot="neck"></div>
                    <div class="eq-slot equipped" data-slot="body"><div class="eq-item-icon"></div></div><div class="eq-slot" data-slot="back"></div>
                    <div class="eq-slot" data-slot="lhand"></div><div class="eq-slot" data-slot="rhand"></div>
                    <div class="eq-slot" data-slot="legs"></div><div class="eq-slot" data-slot="feet"></div>
                </div>
                <div class="container-panel">
                    <div class="container-header"><span>Player Stats</span></div>
                    <div style="font-size:10px; padding:5px; color:#aaa;">
                        <div>Level: <span id="ui-lvl">1</span></div>
                        <div>Exp: <span id="ui-exp">0</span></div>
                        <div>Cap: <span id="ui-cap">400</span> oz</div>
                        <div>Gold: <span id="ui-gold">0</span></div>
                    </div>
                </div>
            </div>

            <div class="tab-panel" id="backpack-panel" style="display:none;">
                <div class="container-panel">
                    <div class="container-header"><span>Main Backpack</span><span><span id="bp-weight">0</span>/<span id="bp-cap">100</span> oz</span></div>
                    <div class="item-grid" id="main-backpack-grid"></div>
                </div>
            </div>

            <div class="tab-panel" id="battle-panel" style="display:none;">
                <div class="battle-panel" id="battle-list-container"></div>
            </div>

            <div class="tab-panel" id="skills-panel" style="display:none;">
                <div class="container-panel">
                    <div class="container-header"><span>Skills</span></div>
                    <div style="font-size:10px; padding:5px; color:#aaa;">
                        <div>Sword Fighting: <span id="skill-sword">10</span></div>
                        <div>Shielding: <span id="skill-shield">10</span></div>
                        <div>Magic Level: <span id="skill-magic">1</span></div>
                    </div>
                </div>
            </div>

            <div class="tab-panel" id="options-panel" style="display:none;">
                <div class="container-panel">
                    <div class="container-header"><span>Game Settings</span></div>
                    <div style="font-size:10px; padding:5px; color:#aaa;">
                        <div>Sound: ON</div>
                        <div>Graphics: High</div>
                        <div>Language: Spanish</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="status-footer">
            <div class="bar-wrap"><div id="hp-bar-fill" class="bar-fill" style="background:var(--hp-green);"></div><div class="bar-text" id="hp-bar-text">100/100</div></div>
            <div class="bar-wrap"><div id="mp-bar-fill" class="bar-fill" style="background:var(--mp-blue);"></div><div class="bar-text" id="mp-bar-text">50/50</div></div>
        </div>
    </div>
</div>

<script>
/**
 * MYTHICA ADVENTURE: THE GENESIS ENGINE
 * Código Monolítico Completo y Optimizado para Móvil.
 */

const Game = (() => {
    const TILE_SIZE = 32;
    const GAME_MAP_SIZE = 2048; // World size in tiles
    const FPS = 60;
    const PLAYER_SPEED = 200; // ms per tile
    const COMBAT_COOLDOWN = 1500; // ms between attacks

    let canvas, ctx;
    let lastTick = 0;
    let currentMoveDirection = { x: 0, y: 0 };
    let playerExhausted = false;

    // --- ENGRANAJE 1: WORLD STATE & ENTITY MANAGEMENT (BACKEND INVISIBLE) ---
    class Entity {
        constructor(id, name, x, y, z, hp, mHp, type = 'mob') {
            this.id = id;
            this.name = name;
            this.x = x;
            this.y = y;
            this.z = z; // Z-axis for floors
            this.hp = hp;
            this.mHp = mHp;
            this.type = type;
            this.targetable = true;
        }

        takeDamage(amount) {
            this.hp -= amount;
            if (this.hp <= 0) {
                this.hp = 0;
                return true; // Entity is dead
            }
            return false;
        }

        // Placeholder for pixel art
        draw(ctx, offsetX, offsetY) {
            ctx.fillStyle = this.type === 'player' ? "#fff" : "#777";
            ctx.fillRect(this.x * TILE_SIZE + 4 + offsetX, this.y * TILE_SIZE + 4 + offsetY, 24, 24);

            // HP Bar for mobs
            if (this.type === 'mob' && this.hp > 0) {
                ctx.fillStyle = "#000";
                ctx.fillRect(this.x * TILE_SIZE + offsetX, this.y * TILE_SIZE - 8 + offsetY, TILE_SIZE, 4);
                ctx.fillStyle = varColor('--hp-mob');
                ctx.fillRect(this.x * TILE_SIZE + offsetX, this.y * TILE_SIZE - 8 + offsetY, (this.hp / this.mHp) * TILE_SIZE, 4);
            }
        }
    }

    const player = new Entity(0, "Hero", 2000, 2000, 7, 100, 100, 'player');
    player.mp = 50; player.mMp = 50;
    player.lvl = 1; player.exp = 0; player.cap = 400;
    player.gold = 0;
    player.skills = { sword: 10, shield: 10, magic: 1 };
    player.inventory = Array(16).fill(null).map((_, i) => (i === 0 ? { id: 'potion', name: 'HP Potion', count: 5 } : null));

    let mobs = [
        new Entity(1, "Rat", 2005, 2000, 7, 20, 20),
        new Entity(2, "Spider", 1995, 2010, 7, 35, 35),
        new Entity(3, "Skeleton", 2010, 1990, 7, 60, 60),
    ];

    // --- ENGRANAJE 2: RENDERIZADO AVANZADO Y MAPA (FRONTEND VISIBLE) ---
    const Renderer = {
        init(canvasId) {
            canvas = document.getElementById(canvasId);
            ctx = canvas.getContext('2d', { alpha: false });
            // For mobile, fixed resolution or dynamic if needed
            canvas.width = 480; 
            canvas.height = 352;
        },

        drawWorld() {
            ctx.fillStyle = varColor('--bg-dark');
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            const offsetX = canvas.width / 2 - player.x * TILE_SIZE - TILE_SIZE / 2;
            const offsetY = canvas.height / 2 - player.y * TILE_SIZE - TILE_SIZE / 2;
            ctx.translate(offsetX, offsetY);

            // Draw map tiles
            const viewRange = 10; // Tiles to draw around player
            for (let x = player.x - viewRange; x <= player.x + viewRange; x++) {
                for (let y = player.y - viewRange; y <= player.y + viewRange; y++) {
                    // Check bounds for map, actual map data would go here
                    if (x >= 0 && x < GAME_MAP_SIZE && y >= 0 && y < GAME_MAP_SIZE) {
                        ctx.fillStyle = (x + y) % 2 === 0 ? "#111" : "#181818";
                        ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = "#222";
                        ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
            
            // Draw entities (mobs)
            mobs.forEach(mob => mob.draw(ctx, 0, 0));

            // Draw player
            player.draw(ctx, 0, 0);

            ctx.restore();

            // Apply lighting (vignette for dark atmosphere)
            const gradient = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, 50,
                canvas.width / 2, canvas.height / 2, Math.min(canvas.width, canvas.height) / 2
            );
            gradient.addColorStop(0, 'rgba(0,0,0,0)');
            gradient.addColorStop(1, 'rgba(0,0,0,0.8)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
    };

    // --- ENGRANAJE 3: UI MANAGEMENT (INTERFAZ DE USUARIO REACTIVA) ---
    const UI = {
        activeTab: 'equipment',
        logMessages: [],

        init() {
            // Tab system
            document.querySelectorAll('.ui-tab').forEach(tab => {
                tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
            });

            // Populate inventory grid
            this.updateBackpackUI();
            this.updateEquipmentUI();
        },

        switchTab(tabName) {
            document.querySelectorAll('.ui-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.ui-tab[data-tab="${tabName}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-panel').forEach(panel => panel.style.display = 'none');
            document.getElementById(`${tabName}-panel`).style.display = 'flex';
            this.activeTab = tabName;
            this.refreshBattleList(); // Refresh battle list on tab switch
        },

        updateStatusBar() {
            // HP
            const hpPercent = (player.hp / player.mHp) * 100;
            document.getElementById('hp-bar-fill').style.width = `${hpPercent}%`;
            document.getElementById('hp-bar-text').textContent = `${Math.floor(player.hp)}/${player.mHp}`;
            // MP
            const mpPercent = (player.mp / player.mMp) * 100;
            document.getElementById('mp-bar-fill').style.width = `${mpPercent}%`;
            document.getElementById('mp-bar-text').textContent = `${Math.floor(player.mp)}/${player.mMp}`;

            // Player stats
            document.getElementById('ui-lvl').textContent = player.lvl;
            document.getElementById('ui-exp').textContent = player.exp;
            document.getElementById('ui-cap').textContent = player.cap;
            document.getElementById('ui-gold').textContent = player.gold;
            document.getElementById('skill-sword').textContent = player.skills.sword;
            document.getElementById('skill-shield').textContent = player.skills.shield;
            document.getElementById('skill-magic').textContent = player.skills.magic;
        },

        updateBackpackUI() {
            const bpGrid = document.getElementById('main-backpack-grid');
            bpGrid.innerHTML = ''; // Clear existing items
            player.inventory.forEach((item, index) => {
                const itemSlot = document.createElement('div');
                itemSlot.classList.add('item-slot');
                if (item) {
                    // Placeholder for item icon
                    const itemIcon = document.createElement('div');
                    itemIcon.classList.add('eq-item-icon');
                    itemIcon.style.backgroundColor = 'goldenrod'; // Dynamic color for different items
                    itemSlot.appendChild(itemIcon);

                    if (item.count > 1) {
                        const countSpan = document.createElement('span');
                        countSpan.classList.add('item-count');
                        countSpan.textContent = item.count;
                        itemSlot.appendChild(countSpan);
                    }
                    itemSlot.draggable = true; // Enable drag for items
                    itemSlot.dataset.itemId = item.id;
                    itemSlot.dataset.itemIndex = index;
                }
                bpGrid.appendChild(itemSlot);
            });
        },

        updateEquipmentUI() {
            // Logic to update actual equipped items goes here
            // For now, it's just a static placeholder
        },

        refreshBattleList() {
            const blContainer = document.getElementById('battle-list-container');
            blContainer.innerHTML = '';
            
            // Sort by distance (closest first)
            const sortedMobs = [...mobs].sort((a, b) => {
                const distA = Math.hypot(player.x - a.x, player.y - a.y);
                const distB = Math.hypot(player.x - b.x, player.y - b.y);
                return distA - distB;
            });

            sortedMobs.forEach(mob => {
                // Only show mobs within a certain range
                const distance = Math.hypot(player.x - mob.x, player.y - mob.y);
                if (distance < 15) { // Show mobs within 15 tiles
                    const mobEntry = document.createElement('div');
                    mobEntry.classList.add('mob-entry');
                    if (player.target && player.target.id === mob.id) {
                        mobEntry.classList.add('target');
                    }
                    mobEntry.innerHTML = `<span>${mob.name}</span><span>${Math.max(0, Math.floor((mob.hp / mob.mHp) * 100))}%</span>`;
                    mobEntry.addEventListener('click', () => {
                        player.target = 
