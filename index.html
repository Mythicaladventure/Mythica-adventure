<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mythica Online - Full Engine</title>
    <style>
        :root {
            --bg-dark: #2a2a2a; --panel-gray: #3c3c3c; --tibia-gold: #d4af37;
            --health: #00ff00; --mana: #3e93ff; --text: #dfdfdf;
        }
        body { margin: 0; background: #000; overflow: hidden; font-family: Verdana, sans-serif; color: var(--text); user-select: none; touch-action: none; }
        
        /* LOGIN */
        #login-screen { position: absolute; inset: 0; background: radial-gradient(circle, #333, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        .login-panel { background: var(--panel-gray); border: 4px outset #888; padding: 30px; border-radius: 8px; text-align: center; box-shadow: 0 0 30px #000; }
        .input-tibia { background: #111; border: 2px inset #555; padding: 12px; color: var(--tibia-gold); font-weight: bold; width: 200px; margin: 15px 0; text-align: center; }

        /* HUD */
        #game-ui { position: absolute; inset: 0; pointer-events: none; display: none; }
        .hud-module { position: absolute; pointer-events: auto; background: rgba(45,45,45,0.9); border: 3px outset #666; padding: 10px; border-radius: 4px; }
        #stats-panel { top: 10px; right: 10px; width: 180px; }
        .bar { width: 100%; height: 12px; background: #111; border: 1px solid #000; margin: 4px 0; position: relative; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .bar-txt { position: absolute; width: 100%; text-align: center; font-size: 9px; font-weight: bold; color: #fff; text-shadow: 1px 1px #000; }

        /* MENU WINDOW */
        #main-window { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; height: 80%; background: var(--panel-gray); border: 5px outset #888; border-radius: 12px; display: none; flex-direction: column; z-index: 9000; pointer-events: auto; }
        .tabs-header { display: flex; background: #1a1a1a; height: 40px; }
        .tab { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #777; cursor: pointer; border-right: 1px solid #333; }
        .tab.active { background: var(--panel-gray); color: var(--tibia-gold); }
        .content-area { flex: 1; padding: 15px; overflow-y: auto; display: none; }
        .content-area.active { display: block; }

        /* INVENTARIO */
        .set-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 180px; margin: 0 auto; }
        .slot { width: 55px; height: 55px; background: #222; border: 2px inset #444; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #555; text-align: center; }
        #battle-console { background: #000; color: #0f0; font-family: monospace; font-size: 10px; padding: 8px; height: 80px; border: 2px inset #555; overflow-y: auto; margin-top: 10px; }

        /* CONTROLES */
        #joystick { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(0,0,0,0.3); border: 2px solid #555; border-radius: 50%; pointer-events: auto; }
        #stick { position: absolute; width: 40px; height: 40px; background: #777; border: 3px outset #aaa; border-radius: 50%; top: 30px; left: 30px; }
        .action-btns { position: absolute; bottom: 30px; right: 30px; display: flex; gap: 10px; pointer-events: auto; }
        .btn-tibia { width: 65px; height: 65px; border-radius: 50%; border: 4px outset #888; background: var(--panel-gray); color: #fff; font-weight: bold; }
        
        canvas { display: block; image-rendering: pixelated; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-panel">
            <h1 style="color:var(--tibia-gold); margin-bottom:5px;">MYTHICA ONLINE</h1>
            <p style="font-size:10px; color:#aaa;">REGISTRA TU LEYENDA</p>
            <input type="text" id="input-name" class="input-tibia" placeholder="Nombre..." maxlength="12">
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn-tibia" style="width:90px; height:40px; border-radius:4px;" onclick="initGame('GUERRERO')">GUERRERO</button>
                <button class="btn-tibia" style="width:90px; height:40px; border-radius:4px;" onclick="initGame('MAGO')">MAGO</button>
            </div>
        </div>
    </div>

    <div id="game-ui">
        <div id="stats-panel" class="hud-module">
            <div id="hud-char-name" style="color:var(--tibia-gold); font-weight:bold; font-size:12px;">Name</div>
            <div class="bar"><div class="bar-txt" id="hp-txt">100/100</div><div id="hp-fill" class="bar-fill" style="background:var(--health)"></div></div>
            <div class="bar"><div class="bar-txt" id="mp-txt">50/50</div><div id="mp-fill" class="bar-fill" style="background:var(--mana)"></div></div>
            <div style="color:var(--tibia-gold); font-weight:bold; font-size:12px;">ðŸ’° <span id="hud-gold">0</span> | Lvl: <span id="hud-lvl">1</span></div>
        </div>
        <div id="joystick"><div id="stick"></div></div>
        <div class="action-btns">
            <button class="btn-tibia" style="background:#822" onclick="handleAttack()">ATK</button>
            <button class="btn-tibia" onclick="toggleMenu()">MENU</button>
        </div>
    </div>

    <div id="main-window">
        <div class="tabs-header">
            <div class="tab active" onclick="switchTab(event, 'tab-profile')">PERFIL</div>
            <div class="tab" onclick="switchTab(event, 'tab-set')">EQUIPO</div>
            <div class="tab" onclick="switchTab(event, 'tab-shop')">TIENDA</div>
            <div class="tab" style="background:#522; color:#fff; flex:0.3" onclick="toggleMenu()">X</div>
        </div>
        <div id="tab-profile" class="content-area active">
            <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:6px; border:2px inset #444;">
                <h3 id="p-display-name" style="margin:0; color:var(--tibia-gold);">---</h3>
                <div id="p-display-class" style="font-size:11px; color:#aaa;">---</div>
                <div id="stats-list" style="margin-top:10px; font-size:12px; line-height:1.6;"></div>
            </div>
            <div id="battle-console">Consola iniciada...</div>
        </div>
        <div id="tab-set" class="content-area">
            <div class="set-container" id="inv-grid">
                <div class="slot">HEAD</div><div class="slot">CHEST</div><div class="slot">LEGS</div>
                <div class="slot">FEET</div><div class="slot">WEAPON</div><div class="slot">SHIELD</div>
            </div>
        </div>
        <div id="tab-shop" class="content-area">
            <h4 style="color:var(--tibia-gold)">MERCADER DARIUS</h4>
            <div id="shop-render"></div>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // VARIABLES DE JUEGO
        let p = { name:"", cl:"", lvl:1, exp:0, next:100, gold:0, hp:100, mHp:100, mp:50, mMp:50, atk:30, def:10, x:2500, y:2500, target:null };
        let mobs = [], particles = [], inventory = [], gameActive = false, move = {x:0,y:0};
        const monsters = [
            { n:"Slime", t:1, hp:100, d:5, exp:40, c:"#fff", g:10 },
            { n:"Orc", t:2, hp:500, d:20, exp:150, c:"#ff0", g:40 },
            { n:"Dragon", t:4, hp:3500, d:80, exp:2000, c:"#f00", g:500 }
        ];

        function initGame(voc) {
            const name = document.getElementById('input-name').value;
            if(!name) return alert("Escribe un nombre");
            p.name = name.toUpperCase(); p.cl = voc;
            if(voc === 'MAGO'){ p.atk=55; p.mHp=80; p.hp=80; p.mMp=200; p.mp=200; }
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            updateUI(); syncProfile(); renderShop();
            gameActive = true; loop();
            log(`Bienvenido, ${p.name}.`);
        }

        function loop() {
            if(!gameActive) return;
            p.x += move.x * 6; p.y += move.y * 6;
            let biomaColor = (p.y > 3500) ? "#2a0a0a" : "#1a2e1a"; // Infierno o Bosque
            
            ctx.fillStyle = biomaColor;
            ctx.fillRect(0,0,canvas.width,canvas.height);
            
            let camX = p.x - canvas.width/2;
            let camY = p.y - canvas.height/2;
            
            ctx.save();
            ctx.translate(-camX, -camY);
            
            // NPC Darius en el Templo
            ctx.fillStyle = "#ffd700"; ctx.fillRect(2500-20, 2450-20, 40, 40);
            ctx.fillStyle = "#fff"; ctx.font = "10px Arial"; ctx.fillText("DARIUS", 2485, 2420);

            // Monsters Spawn
            if(mobs.length < 15) {
                let m = monsters[Math.floor(Math.random()*monsters.length)];
                mobs.push({...m, id:Math.random(), x:p.x+(Math.random()*1200-600), y:p.y+(Math.random()*1200-600), cur:m.hp});
            }

            mobs.forEach(m => {
                ctx.fillStyle = m.c; ctx.fillRect(m.x-20, m.y-20, 40, 40);
                if(p.target === m){ ctx.strokeStyle="red"; ctx.lineWidth=2; ctx.strokeRect(m.x-25, m.y-25, 50, 50); }
                ctx.fillStyle="red"; ctx.fillRect(m.x-20, m.y-30, (m.cur/m.hp)*40, 4);
            });

            ctx.fillStyle = "#3e93ff"; ctx.fillRect(p.x-25, p.y-25, 50, 50);
            ctx.restore();
            
            drawParticles();
            requestAnimationFrame(loop);
        }

        function handleAttack() {
            if(!p.target) return;
            if(Math.hypot(p.x-p.target.x, p.y-p.target.y) > 150) return log("Muy lejos.");
            let dmg = Math.max(0, (p.atk + Math.floor(Math.random()*15)) - p.target.d);
            p.target.cur -= dmg;
            createP(p.target.x, p.target.y, "#ff0", dmg || "MISS");
            if(p.target.cur <= 0){
                log(`Derrotado: ${p.target.n} (+${p.target.exp} exp)`);
                p.exp += p.target.exp; p.gold += p.target.g;
                if(Math.random() > 0.7) { inventory.push({n:"Pocion", v:50}); renderInv(); log("Â¡Loot!"); }
                mobs = mobs.filter(m => m.id !== p.target.id); p.target = null;
                if(p.exp >= p.next){ p.lvl++; p.exp=0; p.next*=2; p.mHp+=20; p.hp=p.mHp; log("Â¡LEVEL UP!"); }
            }
            updateUI();
        }

        function createP(x,y,c,t){ particles.push({x,y,c,t,l:1}); }
        function drawParticles() {
            let camX = p.x - canvas.width/2; let camY = p.y - canvas.height/2;
            ctx.save(); ctx.translate(-camX, -camY);
            for(let i=particles.length-1; i>=0; i--){
                let part = particles[i]; part.y -= 1; part.l -= 0.02;
                if(part.l <= 0){ particles.splice(i,1); continue; }
                ctx.globalAlpha = part.l; ctx.fillStyle = part.c; ctx.font = "bold 16px Arial"; ctx.fillText(part.t, part.x, part.y);
            }
            ctx.restore(); ctx.globalAlpha = 1;
        }

        // CONTROLES
        const joy = document.getElementById('joystick'), stick = document.getElementById('stick');
        joy.addEventListener('touchmove', (e) => {
            let r = joy.getBoundingClientRect();
            let dx = e.touches[0].clientX - (r.left + 50), dy = e.touches[0].clientY - (r.top + 50);
            let d = Math.hypot(dx, dy); if(d > 40){ dx*=40/d; dy*=40/d; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`; move = {x:dx/40, y:dy/40};
        });
        joy.addEventListener('touchend', () => { move={x:0,y:0}; stick.style.transform="translate(0,0)"; });
        canvas.addEventListener('touchstart', (e) => {
            let tx = e.touches[0].clientX + (p.x - canvas.width/2);
            let ty = e.touches[0].clientY + (p.y - canvas.height/2);
            p.target = null; mobs.forEach(m => { if(Math.hypot(tx-m.x, ty-m.y) < 50) p.target = m; });
        });

        // UI
        function toggleMenu(){ let m=document.getElementById('main-window'); m.style.display=(m.style.display==='flex')?'none':'flex'; syncProfile(); }
        function switchTab(e, id) {
            document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active'); e.currentTarget.classList.add('active');
        }
        function log(m){ let c=document.getElementById('battle-console'); c.innerHTML+=`<br>> ${m}`; c.scrollTop=c.scrollHeight; }
        function updateUI(){
            document.getElementById('hud-char-name').innerText = p.name;
            document.getElementById('hp-fill').style.width = (p.hp/p.mHp*100)+"%";
            document.getElementById('hp-txt').innerText = `${p.hp}/${p.mHp}`;
            document.getElementById('hud-gold').innerText = p.gold;
            document.getElementById('hud-lvl').innerText = p.lvl;
        }
        function syncProfile(){
            document.getElementById('p-display-name').innerText = p.name;
            document.getElementById('p-display-class').innerText = "VOCACIÃ“N: " + p.cl;
            document.getElementById('stats-list').innerHTML = `ATAQUE: ${p.atk}<br>DEFENSA: ${p.def}<br>EXP: ${p.exp} / ${p.next}`;
        }
        function renderInv(){
            const slots = document.querySelectorAll('.slot');
            inventory.forEach((it, i) => { if(slots[i]) slots[i].innerHTML = `<div style="color:cyan">${it.n}</div>`; });
        }
        function renderShop(){
            document.getElementById('shop-render').innerHTML = `
                <div style="background:#222; padding:10px; border:1px solid #555; display:flex; justify-content:space-between;">
                    <span>Mega Pocion (100g)</span>
                    <button onclick="buy(100)" style="background:var(--tibia-gold); border:0; padding:4px;">COMPRAR</button>
                </div>`;
        }
        function buy(price){ if(p.gold >= price){ p.gold-=price; inventory.push({n:"MegaPocion",v:100}); renderInv(); log("Compra exitosa."); updateUI(); } }

        window.onresize = () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; };
        window.onresize();
    </script>
</body>
</html>
