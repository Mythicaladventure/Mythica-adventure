<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser3-rex-plugins@1.1.39/dist/rexvirtualjoystickplugin.min.js"></script>
    <style> body { margin: 0; background: #000; } </style>
</head>
<body>
<script>
const config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: { default: 'arcade', arcade: { debug: false } },
    scene: { preload: preload, create: create, update: update }
};

const game = new Phaser.Game(config);
let player, monster, joystick, cursors;

function preload() {
    // Plugin del Joystick
    this.load.plugin('rexvirtualjoystickplugin', 'https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexvirtualjoystickplugin.min.js', true);
}

function create() {
    // 1. Fondo de Pasto Genérico (Tiles de 32x32)
    const graphics = this.add.graphics();
    graphics.fillStyle(0x2d5e32, 1); // Verde oscuro
    for (let x = 0; x < 2000; x += 32) {
        for (let y = 0; y < 2000; y += 32) {
            graphics.fillRect(x, y, 31, 31);
        }
    }

    // 2. Jugador (Azul)
    player = this.physics.add.sprite(400, 300, null);
    player.setRectShape(32, 32, 0x0000ff); // Representación visual básica
    player.setCollideWorldBounds(true);

    // 3. Monstruo (Rojo)
    monster = this.physics.add.sprite(500, 350, null);
    monster.setRectShape(32, 32, 0xff0000);
    monster.hp = 100;

    // 4. Cámara estilo MMORPG (Sigue al jugador)
    this.cameras.main.startFollow(player);
    this.cameras.main.setBounds(0, 0, 2000, 2000);

    // 5. Joystick Inteligente
    joystick = this.plugins.get('rexvirtualjoystickplugin').add(this, {
        x: 100, y: 500, radius: 50,
        base: this.add.circle(0, 0, 50, 0x888888),
        thumb: this.add.circle(0, 0, 25, 0xcccccc),
    });

    // 6. Lógica de Ataque tipo Tibia (Click en el monstruo)
    monster.setInteractive(new Phaser.Geom.Rectangle(0, 0, 32, 32), Phaser.Geom.Rectangle.Contains);
    monster.on('pointerdown', () => {
        const dist = Phaser.Math.Distance.Between(player.x, player.y, monster.x, monster.y);
        if (dist < 60) { // Distancia de ataque (cuerpo a cuerpo)
            atacarMonstruo();
        } else {
            console.log("Muy lejos para atacar");
        }
    });
}

function update() {
    // Movimiento con Joystick
    const force = joystick.force;
    const angle = joystick.angle;

    if (force > 0) {
        this.physics.velocityFromRotation(Phaser.Math.DegToRad(angle), 150, player.body.velocity);
    } else {
        player.setVelocity(0);
    }
}

function atacarMonstruo() {
    monster.hp -= 10;
    console.log("¡Golpe! HP del Monstruo: " + monster.hp);
    
    // Feedback visual (parpadeo rojo)
    monster.setTint(0xff0000);
    setTimeout(() => monster.clearTint(), 100);

    if (monster.hp <= 0) {
        monster.destroy();
        console.log("Monstruo derrotado");
    }
}

// Helper para crear cuadrados sin imágenes externas
Phaser.GameObjects.Sprite.prototype.setRectShape = function(w, h, color) {
    const rect = this.scene.add.graphics();
    rect.fillStyle(color, 1);
    rect.fillRect(-w/2, -h/2, w, h);
    rect.generateTexture('rect' + color, w, h);
    this.setTexture('rect' + color);
    rect.destroy();
};
</script>
</body>
</html>
